<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Recomendador de Fertilizantes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body {
            height: 100%;
            font-family: 'Segoe UI', sans-serif;
        }

        .hero-bg {
            background-image: url("{{ url_for('static', filename='img/hortaliza2.jpg') }}");
            background-size: cover;
            background-position: center;
        }

        .card-hover:hover {
            transform: scale(1.03);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="hero-bg text-white relative">
    <div class="absolute inset-0 bg-black bg-opacity-70 z-0"></div>

    <nav
        class="relative z-10 flex justify-between items-center px-6 py-5 bg-white bg-opacity-5 backdrop-blur-lg shadow-md rounded-b-3xl">
        <h1 class="text-3xl font-bold text-green-200 drop-shadow">
            <span class="inline-block mr-2 animate-bounce">🧪</span>Recomendador de Fertilizantes | {{ username }}
        </h1>
        <button id="logoutBtn"
            class="px-4 py-2 text-white font-semibold rounded-xl transition bg-gradient-to-tr from-green-400 to-emerald-700 hover:from-emerald-600 hover:to-green-400 shadow-lg"
            aria-label="Cerrar sesión">
            🔒 Cerrar sesión
        </button>
    </nav>

    <main class="relative z-10 px-6 py-12">
        <section class="max-w-4xl mx-auto bg-white bg-opacity-10 backdrop-blur-xl rounded-3xl p-6 text-white">
            <h2 class="text-2xl font-bold mb-6 text-green-100">Recomendador de Fertilizantes</h2>
            <form method="post" class="grid gap-4" id="formularioFertilizacion">
                <!-- Cultivo -->
                <label class="block">
                    <span class="text-green-200">Cultivo:</span>
                    <select name="cultivo" required class="w-full p-2 rounded bg-green-900 bg-opacity-50 text-white">
                        <option value="" selected disabled>-- Seleccionar --</option>
                        {% for c in cultivos %}
                        <option value="{{c}}">{{c|capitalize}}</option>
                        {% endfor %}
                    </select>
                </label>
                <!-- Suelo -->
                <label class="block">
                    <span class="text-green-200">Suelo:</span>
                    <select name="suelo" required class="w-full p-2 rounded bg-green-900 bg-opacity-50 text-white">
                        <option value="" selected disabled>-- Seleccionar --</option>
                        {% for s in suelos %}
                        <option value="{{s}}">{{s|capitalize}}</option>
                        {% endfor %}
                    </select>
                </label>
                <!-- Clima -->
                <label class="block">
                    <span class="text-green-200">Clima:</span>
                    <select name="clima" required class="w-full p-2 rounded bg-green-900 bg-opacity-50 text-white">
                        <option value="" selected disabled>-- Seleccionar --</option>
                        {% for clima in climas %}
                        <option value="{{clima}}">{{clima|capitalize}}</option>
                        {% endfor %}
                    </select>
                </label>
                <!-- Etapa del Cultivo -->
                <label class="block">
                    <span class="text-green-200">Etapa del Cultivo:</span>
                    <select name="etapa" class="w-full p-2 rounded bg-green-900 bg-opacity-50 text-white">
                        <option value="" selected disabled>-- Seleccionar --</option>
                        {% for etapa in etapas %}
                        <option value="{{etapa}}">{{etapa|capitalize}}</option>
                        {% endfor %}
                    </select>
                </label>
                <!-- Variedad -->
                <label class="block">
                    <span class="text-green-200">Variedad:</span>
                    <select name="variedad" id="variedad"
                        class="w-full p-2 rounded bg-green-900 bg-opacity-50 text-white">
                        <option value="" selected disabled>-- Seleccionar --</option>
                        {% for v in variedades %}
                        <option value="{{v}}">{{v|capitalize}}</option>
                        {% endfor %}
                    </select>
                </label>
                <div class="flex gap-4">
                    <button type="submit"
                        class="mt-4 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded flex-1">
                        Recomendar
                    </button>
                 
                </div>
            </form>

            {% if resultado %}
            <div id="resultadoContainer" class="mt-10 result-card rounded-xl p-6 shadow-xl">
                <h3 class="text-xl font-bold mb-4 text-green-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Recomendación de Fertilización
                </h3>
                <!-- Resultado -->
                {% if resultado is mapping %}
                <div
                    class="space-y-4 bg-gradient-to-br from-green-900 to-green-700 rounded-xl shadow-lg p-6 border border-green-300">
                    <h4 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                        🌾 Recomendación Personalizada
                    </h4>
                    <ul class="list-disc pl-6 space-y-3 text-lg text-white">
                        {% if resultado.formula %}
                        <li><span class="font-semibold text-green-200">Fórmula:</span> {{ resultado.formula }}.</li>
                        {% endif %}
                        {% if resultado.dosis %}
                        <li><span class="font-semibold text-green-200">Dosis:</span> {{ resultado.dosis }}.</li>
                        {% endif %}
                        {% if resultado.aplicacion %}
                        <li><span class="font-semibold text-green-200">Aplicación:</span> {{ resultado.aplicacion }}.
                        </li>
                        {% endif %}
                        {% if resultado.fabricantes %}
                        <li><span class="font-semibold text-green-200">Fabricantes:</span> {{
                            resultado.fabricantes|join(', ') }}.</li>
                        {% endif %}
                        {% if resultado.precauciones %}
                        <li><span class="font-semibold text-yellow-300">Precauciones:</span> {{ resultado.precauciones
                            }}.</li>
                        {% endif %}
                    </ul>
                    {% if resultado.condiciones %}
                    <div class="mt-6 bg-white bg-opacity-5 p-4 rounded-lg border border-green-500">
                        <p class="text-sm text-green-200 font-semibold uppercase mb-2">Condiciones Aplicadas</p>
                        <ul class="text-white space-y-1 list-disc pl-6">
                            {% if resultado.condiciones.suelo %}
                            <li><strong>Suelo:</strong> {{ resultado.condiciones.suelo|capitalize }}</li>
                            {% endif %}
                            {% if resultado.condiciones.clima %}
                            <li><strong>Clima:</strong> {{ resultado.condiciones.clima|capitalize }}</li>
                            {% endif %}
                            {% if resultado.condiciones.variedad %}
                            <li><strong>Variedad:</strong> {{ resultado.condiciones.variedad|capitalize }}</li>
                            {% endif %}
                            {% if resultado.condiciones.etapa %}
                            <li><strong>Etapa:</strong> {{ resultado.condiciones.etapa|capitalize }}</li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="bg-green-900 bg-opacity-30 rounded-lg p-4">
                    {% if resultado is string %}
                    <p class="text-lg">{{ resultado }}</p>
                    {% else %}
                    <ul class="list-disc pl-5 space-y-2">
                        {% for item in resultado %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="mt-4 flex justify-end gap-4">
                <button id="limpiarBtn"
                    class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded shadow transition">
                    Limpiar resultados
                </button>
                <div id="pdfBtnContainer">
                    <button id="pdfBtn"
                        class="px-4 py-2 bg-green-700 hover:bg-green-900 text-white font-semibold rounded shadow transition">
                        Imprimir/Descargar PDF
                    </button>
                </div>
            </div>
            {% endif %}

            {% if sugerencias %}
            <div id="sugerenciasContainer"
                class="mt-6 bg-yellow-500 bg-opacity-20 rounded-xl p-4 shadow text-yellow-100">
                <h3 class="text-lg font-semibold mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd" />
                    </svg>
                    Sugerencias adicionales
                </h3>
                <ul class="list-disc pl-5 space-y-1">
                    {% for sugerencia in sugerencias %}
                    <li>{{ sugerencia }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if advertencias %}
            <div id="advertenciasContainer" class="mt-6 bg-red-600 bg-opacity-20 rounded-xl p-4 shadow text-red-200">
                <h3 class="text-lg font-semibold mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z"
                            clip-rule="evenodd" />
                    </svg>
                    Advertencias importantes
                </h3>
                <ul class="list-disc pl-5 space-y-1">
                    {% for adv in advertencias %}
                    <li>{{ adv }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="mt-6">
                <a href="/home" class="text-green-300 underline hover:text-green-400 transition">← Volver al inicio</a>
            </div>
        </section>
    </main>

    <script>
        window.parametrosConsulta = {{ parametros_form | tojson | safe }};
        document.addEventListener("DOMContentLoaded", function () {
            // Botón cerrar sesión
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                window.location.href = '/logout';
            });

            // Forzar logout si retrocede
            if (window.history && window.history.pushState) {
                window.history.pushState(null, null, window.location.href);
                window.onpopstate = function () {
                    window.location.href = '/logout';
                };
            }

            const form = document.getElementById("formularioFertilizacion");
            const variedadSelect = document.getElementById("variedad");
            const limpiarBtn = document.getElementById("limpiarBtn");

            // Cambio de cultivo para cargar variedades dinámicas
            const cultivoSelect = document.querySelector("select[name='cultivo']");
            cultivoSelect?.addEventListener("change", function () {
                const cultivoSeleccionado = this.value;
                fetch(`/get_variedades/${cultivoSeleccionado}`)
                    .then(response => response.json())
                    .then(data => {
                        variedadSelect.innerHTML = '<option value="" selected disabled>-- Seleccionar --</option>';
                        data.forEach(function (variedad) {
                            const option = document.createElement("option");
                            option.value = variedad;
                            option.textContent = variedad.charAt(0).toUpperCase() + variedad.slice(1);
                            variedadSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Error al cargar variedades:", error);
                    });
            });

            // Mostrar u ocultar el botón limpiar dependiendo del resultado
            {% if resultado %}
            limpiarBtn.classList.remove('hidden');
            {% else %}
            limpiarBtn.classList.add('hidden');
            {% endif %}

            // Si hay resultado, ocultar el formulario y mostrar resultados
            {% if resultado %}
            form.classList.add('hidden');
            document.getElementById('resultadoContainer')?.classList.remove('hidden');
            document.getElementById('pdfBtnContainer')?.classList.remove('hidden');
            document.getElementById('sugerenciasContainer')?.classList.remove('hidden');
            document.getElementById('advertenciasContainer')?.classList.remove('hidden');
            {% endif %}

            // Al limpiar, mostrar formulario, ocultar resultados y botón limpiar
            limpiarBtn?.addEventListener('click', function () {
                document.getElementById('resultadoContainer')?.classList.add('hidden');
                document.getElementById('sugerenciasContainer')?.classList.add('hidden');
                document.getElementById('advertenciasContainer')?.classList.add('hidden');
                document.getElementById('pdfBtnContainer')?.classList.add('hidden');
                limpiarBtn.classList.add('hidden'); // OCULTAR el botón
                form.reset();
                form.classList.remove('hidden');
                if (variedadSelect) {
                    variedadSelect.innerHTML = '<option value="" selected disabled>-- Seleccionar --</option>';
                }
            });

            // PDF descarga
            const pdfBtn = document.getElementById('pdfBtn');
            if (pdfBtn) {
                pdfBtn.addEventListener('click', function () {
                    const params = window.parametrosConsulta || {};
                    const resultado = {{ resultado| tojson | safe
                }};
            const advertencias = {{ advertencias| tojson | safe
        }};
        const sugerencias = {{ sugerencias| tojson | safe }};

        fetch('/fertilizante/pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                parametros: params,
                resultado: resultado,
                advertencias: advertencias,
                sugerencias: sugerencias
            })
        })
            .then(response => {
                if (response.ok) return response.blob();
                throw new Error('No se pudo generar el PDF');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'recomendacion_fertilizante.pdf';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => {
                alert('Error al generar el PDF: ' + err);
            });
        });
    }
});
    </script>
</body>

</html>